{% load static %}
<!DOCTYPE html>
<html lang="{{ detected_language|default:'en' }}">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      {% if status == 'success' %}Device Activated - Padmakara{% else
      %}Activation Error - Padmakara{% endif %}
    </title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          "Inter", sans-serif;
        background: linear-gradient(135deg, #fefdfb 0%, #fcf8f3 100%);
        min-height: 100vh;
        color: #374151;
        line-height: 1.6;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
        padding: 40px 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .card {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 10px 50px rgba(185, 28, 28, 0.08);
        text-align: center;
        width: 100%;
        max-width: 500px;
        border: 1px solid #f7f0e4;
      }

      .icon-container {
        margin-bottom: 30px;
      }

      .icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        font-size: 40px;
        color: white;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      }

      .icon.success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      }

      .icon.error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      }

      .icon.loading {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        animation: spin 2s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .title {
        font-size: 28px;
        font-weight: 700;
        color: #b91c1c;
        margin-bottom: 16px;
        font-family: Georgia, serif;
      }

      .title.success {
        color: #10b981;
      }

      .title.error {
        color: #ef4444;
      }

      .message {
        font-size: 16px;
        color: #6b7280;
        margin-bottom: 30px;
        line-height: 1.6;
      }

      .details {
        background: #f7f0e4;
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
        border-left: 4px solid #f59e0b;
      }

      .detail-item {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        font-size: 14px;
        color: #4b5563;
      }

      .detail-item:last-child {
        margin-bottom: 0;
      }

      .detail-icon {
        width: 16px;
        height: 16px;
        margin-right: 12px;
        flex-shrink: 0;
      }

      .context-section {
        margin-top: 30px;
        padding-top: 30px;
        border-top: 1px solid #e5e7eb;
      }

      .context-title {
        font-size: 20px;
        font-weight: 600;
        color: #b91c1c;
        margin-bottom: 20px;
      }

      .platform-options {
        display: grid;
        gap: 15px;
        margin-top: 20px;
      }

      .platform-option {
        display: flex;
        align-items: center;
        padding: 16px;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        text-decoration: none;
        transition: all 0.3s ease;
        color: inherit;
      }

      .platform-option:hover {
        border-color: #f59e0b;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
        transform: translateY(-2px);
      }

      .platform-icon {
        width: 40px;
        height: 40px;
        margin-right: 16px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: white;
      }

      .platform-icon.ios {
        background: #007aff;
      }
      .platform-icon.android {
        background: #34a853;
      }
      .platform-icon.web {
        background: #f59e0b;
      }
      .platform-icon.desktop {
        background: #6b7280;
      }

      .platform-content {
        flex: 1;
        text-align: left;
      }

      .platform-title {
        font-weight: 600;
        color: #374151;
        margin-bottom: 4px;
      }

      .platform-description {
        font-size: 13px;
        color: #6b7280;
      }

      .same-browser-section {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
      }

      .same-browser-title {
        font-weight: 600;
        color: #166534;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
      }

      .same-browser-title::before {
        content: "✨";
        margin-right: 8px;
      }

      .countdown {
        font-weight: 600;
        color: #f59e0b;
      }

      .loading-indicator {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #f3f4f6;
        border-radius: 50%;
        border-top-color: #f59e0b;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
      }

      @media (max-width: 480px) {
        .container {
          padding: 20px 16px;
        }

        .card {
          padding: 30px 20px;
        }

        .title {
          font-size: 24px;
        }

        .icon {
          width: 60px;
          height: 60px;
          font-size: 30px;
        }
      }

      /* Context detection styles */
      .context-mobile .platform-options {
        grid-template-columns: 1fr;
      }

      .context-desktop .platform-options {
        grid-template-columns: repeat(2, 1fr);
      }

      .hidden {
        display: none;
      }

      /* Language Switcher Styles */
      .language-switcher {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
      }

      .language-toggle {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .language-toggle:hover {
        border-color: #f59e0b;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
      }

      .language-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 4px;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 120px;
        overflow: hidden;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
      }

      .language-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .language-option {
        display: block;
        padding: 10px 12px;
        color: #374151;
        text-decoration: none;
        font-size: 14px;
        transition: background-color 0.2s ease;
        cursor: pointer;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
      }

      .language-option:hover {
        background-color: #f9fafb;
      }

      .language-option.active {
        background-color: #fef3c7;
        color: #92400e;
        font-weight: 600;
      }


      @media (max-width: 480px) {
        .language-switcher {
          top: 16px;
          right: 16px;
        }
        
        .language-toggle {
          padding: 6px 8px;
          font-size: 13px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Language Switcher -->
    <div class="language-switcher">
      <div class="language-toggle" onclick="toggleLanguageDropdown()">
        <span id="current-language">English</span>
        <span style="margin-left: 4px;">▾</span>
      </div>
      <div class="language-dropdown" id="language-dropdown">
        <button class="language-option" data-lang="en" onclick="switchLanguage('en')">
          English
        </button>
        <button class="language-option" data-lang="pt" onclick="switchLanguage('pt')">
          Português
        </button>
      </div>
    </div>

    <div class="container">
      <div class="card">
        <!-- Loading State (shown while detecting context) -->
        <div id="loading-state">
          <div class="icon-container">
            <div class="icon loading">
              <span class="loading-indicator"></span>
            </div>
          </div>
          <h1 class="title" id="loading-title">Activating Device</h1>
          <p class="message" id="loading-message">
            Please wait while we activate your device and prepare your
            experience...
          </p>
        </div>

        <!-- Success State -->
        <div id="success-state" class="hidden">
          <div class="icon-container">
            <div class="icon success">✓</div>
          </div>

          <h1 class="title success" id="success-title">Device Activated!</h1>
          <p class="message" id="success-message">
            Welcome to Padmakara! Your device has been successfully activated.
          </p>

          <div class="details">
            <div class="detail-item">
              <span class="detail-icon">👤</span>
              <span
                ><span id="signed-in-label">Signed in as</span>
                <strong>{{ user_name|default:"User" }}</strong></span
              >
            </div>
            <div class="detail-item">
              <span class="detail-icon">📱</span>
              <span
                ><span id="device-label">Device:</span>
                <strong>{{ device_name|default:"This Device" }}</strong></span
              >
            </div>
            <div class="detail-item">
              <span class="detail-icon">🕐</span>
              <span><span id="activated-label">Activated:</span> <strong id="activation-time"></strong></span>
            </div>
          </div>

          <!-- Context-aware options will be inserted here by JavaScript -->
          <div id="context-options"></div>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden">
          <div class="icon-container">
            <div class="icon error">✗</div>
          </div>

          <h1 class="title error" id="error-title">Activation Failed</h1>
          <p class="message" id="error-message">
            {{ error_message|default:"The activation link may have expired or
            been used already." }}
          </p>

          <div class="details">
            <div class="detail-item">
              <span class="detail-icon">💡</span>
              <span id="error-help"
                >Try requesting a new magic link or contact support if the
                problem persists.</span
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Load translation system -->
    <script src="{% static 'activation/translations.js' %}?v={{ timestamp|default:'1' }}"></script>
    
    <script>
      // Context detection and activation handling
      (function () {
        const activationData = {
          status: "{{ status }}",
          user_name: '{{ user_name|default:"" }}',
          device_name: '{{ device_name|default:"" }}',
          error_message: '{{ error_message|default:"" }}',
        };
        
        // Make activation data globally available
        window.activationData = activationData;

        // Enhanced device and context detection
        function detectActivationContext() {
          const userAgent = navigator.userAgent;
          const platform = navigator.platform;
          const isMobile =
            /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
              userAgent
            );
          const isTablet = /iPad|Android.*(?!.*Mobile)/i.test(userAgent);
          const isIOS = /iPhone|iPad|iPod/i.test(userAgent);
          const isAndroid = /Android/i.test(userAgent);
          const isMac = /Mac|darwin/i.test(platform);
          const isWindows = /Win/i.test(platform);

          // Check if this was opened from the same browser (simple heuristic)
          const activationState = localStorage.getItem(
            "padmakara_activation_state"
          );
          const isSameBrowser = activationState === "waiting_for_activation";

          return {
            isMobile: isMobile && !isTablet,
            isTablet,
            isDesktop: !isMobile && !isTablet,
            isIOS,
            isAndroid,
            isMac,
            isWindows,
            isSameBrowser,
            platform: isMobile ? "mobile" : isTablet ? "tablet" : "desktop",
          };
        }

        function generateBrowserFingerprint() {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          ctx.textBaseline = "top";
          ctx.font = "14px Arial";
          ctx.fillText("Browser fingerprint", 2, 2);

          const fingerprint = [
            navigator.userAgent,
            navigator.language,
            screen.width + "x" + screen.height,
            new Date().getTimezoneOffset(),
            canvas.toDataURL(),
          ].join("|");

          return btoa(fingerprint).substring(0, 32);
        }

        function createPlatformOptions(context) {
          const t = ActivationTranslator.t.bind(ActivationTranslator);
          const optionsHtml = `
                    <div class="context-section">
                        <h3 class="context-title">${t('access_title')}</h3>
                        <p id="access-description" style="color: #6b7280; font-size: 14px; margin-bottom: 20px; text-align: center; line-height: 1.5;">
                            ${t('access_description')}
                        </p>
                        <div class="platform-options context-${
                          context.platform
                        }">
                            ${
                              context.isMobile
                                ? `
                                <a href="#" class="platform-option" onclick="openAppStore('ios')" ${
                                  context.isIOS ? "" : 'style="display:none"'
                                }>
                                    <div class="platform-icon ios">📱</div>
                                    <div class="platform-content">
                                        <div class="platform-title">${t('download_iphone')}</div>
                                        <div class="platform-description">${t('download_iphone_desc')}</div>
                                    </div>
                                </a>
                                <a href="#" class="platform-option" onclick="openAppStore('android')" ${
                                  context.isAndroid
                                    ? ""
                                    : 'style="display:none"'
                                }>
                                    <div class="platform-icon android">📱</div>
                                    <div class="platform-content">
                                        <div class="platform-title">${t('download_android')}</div>
                                        <div class="platform-description">${t('download_android_desc')}</div>
                                    </div>
                                </a>
                            `
                                : ""
                            }
                            
                            <a href="#" class="platform-option" onclick="openWebApp()">
                                <div class="platform-icon web">🌐</div>
                                <div class="platform-content">
                                    <div class="platform-title">${t('open_web_app')}</div>
                                    <div class="platform-description">${t('open_web_app_desc')}</div>
                                </div>
                            </a>
                            
                            ${
                              context.isDesktop
                                ? `
                                <a href="#" class="platform-option" onclick="downloadDesktop('mac')" ${
                                  context.isMac ? "" : 'style="display:none"'
                                }>
                                    <div class="platform-icon desktop">💻</div>
                                    <div class="platform-content">
                                        <div class="platform-title">${t('download_macos')}</div>
                                        <div class="platform-description">${t('download_macos_desc')}</div>
                                    </div>
                                </a>
                                <a href="#" class="platform-option" onclick="downloadDesktop('windows')" ${
                                  context.isWindows
                                    ? ""
                                    : 'style="display:none"'
                                }>
                                    <div class="platform-icon desktop">💻</div>
                                    <div class="platform-content">
                                        <div class="platform-title">${t('download_windows')}</div>
                                        <div class="platform-description">${t('download_windows_desc')}</div>
                                    </div>
                                </a>
                            `
                                : ""
                            }
                        </div>
                        
                        ${
                          context.isSameBrowser
                            ? `
                            <div class="same-browser-section">
                                <div class="same-browser-title">${t('same_browser_title')}</div>
                                <p>${t('same_browser_message', { seconds: '<span class="countdown" id="countdown">3</span>' })}</p>
                            </div>
                        `
                            : ""
                        }
                    </div>
                `;

          return optionsHtml;
        }

        function handleSameBrowserActivation() {
          localStorage.removeItem("padmakara_activation_state");

          let countdown = 3;
          const countdownElement = document.getElementById("countdown");

          const timer = setInterval(() => {
            countdown--;
            if (countdownElement) {
              countdownElement.textContent = countdown;
            }

            if (countdown <= 0) {
              clearInterval(timer);
              // Try to close the tab or redirect
              try {
                window.close();
              } catch (e) {
                // If can't close, redirect to web app
                openWebApp();
              }
            }
          }, 1000);
        }

        // Platform-specific actions
        window.openAppStore = function (platform) {
          const urls = {
            ios: "https://apps.apple.com/app/padmakara", // Will be provided later
            android:
              "https://play.google.com/store/apps/details?id=com.padmakara", // Will be provided later
          };
          window.open(urls[platform], "_blank");
        };

        window.downloadDesktop = function (platform) {
          const urls = {
            mac: "https://releases.padmakara.app/macos/latest", // Will be provided later
            windows: "https://releases.padmakara.app/windows/latest", // Will be provided later
          };
          window.open(urls[platform], "_blank");
        };

        window.openWebApp = function () {
          window.open(
            '{{ frontend_url|default:"https://app.padmakara.pt" }}',
            "_blank"
          );
        };

        // Language switching functions
        window.toggleLanguageDropdown = function() {
          const dropdown = document.getElementById('language-dropdown');
          dropdown.classList.toggle('show');
          
          // Close dropdown when clicking outside
          document.addEventListener('click', function closeDropdown(e) {
            if (!e.target.closest('.language-switcher')) {
              dropdown.classList.remove('show');
              document.removeEventListener('click', closeDropdown);
            }
          });
        };
        
        window.switchLanguage = function(langCode) {
          ActivationTranslator.switchLanguage(langCode);
          document.getElementById('language-dropdown').classList.remove('show');
          
          // Update current language display
          const currentLanguage = document.getElementById('current-language');
          currentLanguage.textContent = langCode === 'en' ? 'English' : 'Português';
          
          // Regenerate platform options with new language
          const context = detectActivationContext();
          const optionsContainer = document.getElementById('context-options');
          if (optionsContainer && activationData.status === 'success') {
            optionsContainer.innerHTML = createPlatformOptions(context);
          }
        };

        // Initialize the page
        function initializePage() {
          const context = detectActivationContext();
          
          // Initialize translation system with URL parameter priority
          // Always prioritize URL lang parameter over any saved preferences
          const urlParams = new URLSearchParams(window.location.search);
          const urlLanguage = urlParams.get('lang');
          const savedLanguage = localStorage.getItem('padmakara_language');
          
          console.log('DEBUG: URL language:', urlLanguage);
          console.log('DEBUG: Saved language in localStorage:', savedLanguage);
          console.log('DEBUG: Django detected language:', '{{ detected_language|default:"en" }}');
          
          let finalLanguage;
          let forceOverride = false;
          
          if (urlLanguage && ['en', 'pt'].includes(urlLanguage)) {
            // URL parameter takes absolute priority
            finalLanguage = urlLanguage;
            forceOverride = true;
            console.log('DEBUG: Using URL language with force override:', finalLanguage);
          } else {
            // Fall back to Django detected language
            finalLanguage = '{{ detected_language|default:"en" }}';
            console.log('DEBUG: Using Django detected language:', finalLanguage);
          }
          
          console.log('About to call ActivationTranslator.init with:', finalLanguage, forceOverride);
          console.log('ActivationTranslator object:', ActivationTranslator);
          
          // Fallback: if ActivationTranslator is not available, create a minimal version
          if (typeof ActivationTranslator === 'undefined' || !ActivationTranslator.init) {
            console.error('ActivationTranslator not found! Creating fallback.');
            // Simple fallback translation
            if (finalLanguage === 'pt') {
              console.log('Applying Portuguese translations directly');
              const loadingTitle = document.getElementById('loading-title');
              const loadingMessage = document.getElementById('loading-message');
              if (loadingTitle) loadingTitle.textContent = 'Ativando Dispositivo';
              if (loadingMessage) loadingMessage.textContent = 'Por favor aguarde enquanto ativamos o seu dispositivo e preparamos a sua experiência...';
              document.documentElement.lang = 'pt';
            }
          } else {
            ActivationTranslator.init(finalLanguage, forceOverride);
            console.log('ActivationTranslator.init completed, currentLanguage:', ActivationTranslator.currentLanguage);
          }
          
          // Set initial language display
          const currentLanguage = document.getElementById('current-language');
          currentLanguage.textContent = ActivationTranslator.currentLanguage === 'en' ? 'English' : 'Português';

          setTimeout(() => {
            document.getElementById("loading-state").classList.add("hidden");

            if (activationData.status === "success") {
              document
                .getElementById("success-state")
                .classList.remove("hidden");

              // Set activation time
              const timeElement = document.getElementById("activation-time");
              if (timeElement) {
                timeElement.textContent = new Date().toLocaleString();
              }

              // Add context-aware options
              const optionsContainer =
                document.getElementById("context-options");
              if (optionsContainer) {
                optionsContainer.innerHTML = createPlatformOptions(context);
              }

              // Handle same-browser activation
              if (context.isSameBrowser) {
                handleSameBrowserActivation();
              }
            } else {
              document.getElementById("error-state").classList.remove("hidden");
            }
          }, 1500); // Show loading for 1.5 seconds for better UX
        }

        // Start initialization when page loads
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", initializePage);
        } else {
          initializePage();
        }
      })();
    </script>
  </body>
</html>
